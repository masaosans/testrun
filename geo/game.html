<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>3D Character Control with Free Camera</title>
<style>
body{margin:0;overflow:hidden;font-family:Arial,Helvetica;}
#info{
  position:absolute;left:10px;top:10px;z-index:20;background:rgba(255,255,255,0.9);
  padding:8px;border-radius:6px;font-size:13px;
}
#joystick{
  position:absolute;
  bottom:50px;
  left:50px;
  width:120px;
  height:120px;
  z-index:30;
}
</style>
</head>
<body>
<div id="info">スマホ対応ジョイスティック操作</div>
<div id="joystick"></div>

<script src="https://unpkg.com/three@0.145.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.145.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

<script>
// ===================== Scene =====================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xa8dffb);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 5000);
camera.position.set(0, 200, 400);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.1;
controls.enablePan = false;
controls.target.set(0,10,0);

// Light
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(500,1000,500);
scene.add(dir);

// ===================== Ground =====================
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(2000,2000),
  new THREE.MeshPhongMaterial({color:0x99cc99})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ===================== Player =====================
const playerGeometry = new THREE.CapsuleGeometry(5,20,4,8);
const playerMaterial = new THREE.MeshPhongMaterial({color:0xff4444});
const player = new THREE.Mesh(playerGeometry, playerMaterial);
player.position.set(0,10,0);
scene.add(player);

// ===================== Joystick =====================
let joystickDir = {x:0, y:0};
const joystick = nipplejs.create({
  zone: document.getElementById('joystick'),
  mode: 'static',
  position: {left:'50px', bottom:'50px'},
  color: 'gray',
  size: 120
});
joystick.on('move', (evt, data)=>{
  if(data && data.vector){
    joystickDir.x = data.vector.x;
    joystickDir.y = -data.vector.y; // 上下反転
  }
});
joystick.on('end', ()=>{
  joystickDir.x = 0;
  joystickDir.y = 0;
});

// ===================== Player Movement =====================
const speed = 2;
function updatePlayer(){
  const dir = new THREE.Vector3(joystickDir.x,0,joystickDir.y);
  if(dir.length() > 0.1){
    dir.normalize();
    // カメラ水平回転に合わせる
    const camYaw = Math.atan2(
      camera.position.x - player.position.x,
      camera.position.z - player.position.z
    );
    const moveAngle = Math.atan2(dir.x, dir.z);
    const finalAngle = moveAngle + camYaw;
    // キャラ向き
    const delta = finalAngle - player.rotation.y;
    player.rotation.y += delta * 0.2;
    // 移動
    player.position.x += Math.sin(finalAngle)*speed;
    player.position.z += Math.cos(finalAngle)*speed;
  }
}

// ===================== Camera Follow =====================
const camOffset = new THREE.Vector3(0,100,200);
function updateCamera(){
  const desiredPos = player.position.clone().add(camOffset.clone().applyAxisAngle(new THREE.Vector3(0,1,0), controls.getAzimuthalAngle()));
  camera.position.lerp(desiredPos, 0.1);
  controls.target.lerp(player.position.clone().add(new THREE.Vector3(0,10,0)), 0.1);
  controls.update();
}

// ===================== Animation Loop =====================
function animate(){
  requestAnimationFrame(animate);
  updatePlayer();
  updateCamera();
  renderer.render(scene,camera);
}
animate();

// ===================== Resize =====================
window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
