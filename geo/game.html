<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>3D Character Control with Jump & Attack</title>
<style>
body{margin:0;overflow:hidden;font-family:Arial,Helvetica;}
#info{
  position:absolute;left:10px;top:10px;z-index:20;background:rgba(255,255,255,0.9);
  padding:8px;border-radius:6px;font-size:13px;
}
#joystick{
  position:absolute;
  bottom:50px;
  left:50px;
  width:120px;
  height:120px;
  z-index:30;
}
/* ボタン配置 */
.button-container{
  position:absolute;
  bottom:50px;
  right:50px;
  display:flex;
  flex-direction:column;
  gap:15px;
  z-index:30;
}
.button-container button{
  width:80px;
  height:80px;
  border-radius:50%;
  border:none;
  font-size:16px;
  background:rgba(200,200,200,0.7);
  color:#000;
  touch-action: manipulation;
}
</style>
</head>
<body>
<div id="info">スマホ対応ジョイスティック操作</div>
<div id="joystick"></div>
<div class="button-container">
  <button id="jumpBtn">ジャンプ</button>
  <button id="attackBtn">アタック</button>
</div>

<script src="https://unpkg.com/three@0.145.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.145.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

<script>
// ===================== Scene =====================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xa8dffb);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 5000);
camera.position.set(0, 150, 300);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.1;
controls.enablePan = false;
controls.minPolarAngle = Math.PI/6;  
controls.maxPolarAngle = Math.PI/2.3;
controls.target.set(0,10,0);

// Light
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(500,1000,500);
scene.add(dir);

// ===================== Ground =====================
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(2000,2000),
  new THREE.MeshPhongMaterial({color:0x99cc99})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ===================== Player =====================
const playerGeometry = new THREE.CapsuleGeometry(5,20,4,8);
const playerMaterial = new THREE.MeshPhongMaterial({color:0xff4444});
const player = new THREE.Mesh(playerGeometry, playerMaterial);
player.position.set(0,10,0);
scene.add(player);

// ===================== Physics =====================
let velocityY = 0;
const gravity = -1.2;  // 重力
let onGround = true;

// ===================== Joystick =====================
let joystickDir = {x:0, y:0};
const joystick = nipplejs.create({
  zone: document.getElementById('joystick'),
  mode: 'static',
  position: {left:'50px', bottom:'50px'},
  color: 'gray',
  size: 120
});
joystick.on('move', (evt, data)=>{
  if(data && data.vector){
    joystickDir.x = data.vector.x;
    joystickDir.y = -data.vector.y; // 上下反転
  }
});
joystick.on('end', ()=>{
  joystickDir.x = 0;
  joystickDir.y = 0;
});

// ===================== Jump / Attack =====================
document.getElementById('jumpBtn').addEventListener('click', ()=>{
  if(onGround){
    velocityY = 18; // ジャンプ力
    onGround = false;
  }
});
document.getElementById('attackBtn').addEventListener('click', ()=>{
  console.log("Attack button pressed");
});

// ===================== Player Movement =====================
const speed = 2;
function updatePlayer(){
  // 移動
  const dir = new THREE.Vector3(joystickDir.x,0,joystickDir.y);
  if(dir.length() > 0.1){
    dir.normalize();
    const camYaw = Math.atan2(camera.position.x - player.position.x,
                              camera.position.z - player.position.z);
    const moveAngle = Math.atan2(dir.x, dir.z);
    const finalAngle = moveAngle + camYaw;
    // キャラ向き
    const delta = finalAngle - player.rotation.y;
    player.rotation.y += delta * 0.2;
    // 移動
    player.position.x += Math.sin(finalAngle)*speed;
    player.position.z += Math.cos(finalAngle)*speed;
  }

  // 重力・ジャンプ
  if(!onGround){
    velocityY += gravity * 0.5;
    player.position.y += velocityY * 0.5;
    if(player.position.y <= 10){
      player.position.y = 10;
      velocityY = 0;
      onGround = true;
    }
  }
}

// ===================== Camera Follow =====================
const camOffset = new THREE.Vector3(0,120,220);
function updateCamera(){
  const horizontalOffset = new THREE.Vector3(camOffset.x,0,camOffset.z);
  horizontalOffset.applyAxisAngle(new THREE.Vector3(0,1,0), controls.getAzimuthalAngle());
  const desiredPos = player.position.clone().add(horizontalOffset).add(new THREE.Vector3(0,camOffset.y,0));
  camera.position.lerp(desiredPos, 0.1);
  controls.target.lerp(player.position.clone().add(new THREE.Vector3(0,10,0)), 0.1);
  controls.update();
}

// ===================== Animation Loop =====================
function animate(){
  requestAnimationFrame(animate);
  updatePlayer();
  updateCamera();
  renderer.render(scene,camera);
}
animate();

// ===================== Resize =====================
window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
