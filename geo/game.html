<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>3Dキャラクターゲーム（スマホ対応）</title>
<style>
  body{margin:0;overflow:hidden;font-family:Arial,Helvetica;}
  #info{position:absolute;left:10px;top:10px;z-index:20;background:rgba(255,255,255,0.9);padding:8px;border-radius:6px;font-size:13px;}
  #joystickContainer{
    position:absolute;
    bottom:40px; /* 下から余白 */
    left:40px; /* 左から余白 */
    width:150px;
    height:150px;
    touch-action:none;
    z-index:30;
  }
  #jumpBtn, #attackBtn{
    position:absolute;
    bottom:40px;
    width:80px;
    height:80px;
    border-radius:50%;
    background-color:rgba(255,255,255,0.7);
    font-size:18px;
    text-align:center;
    line-height:80px;
    z-index:30;
    user-select:none;
  }
  #jumpBtn{right:130px;}
  #attackBtn{right:40px;}
</style>
</head>
<body>
<div id="info">ジョイスティックで移動。ジャンプボタンでジャンプ。</div>

<div id="joystickContainer"></div>
<div id="jumpBtn">Jump</div>
<div id="attackBtn">Attack</div>

<script src="https://unpkg.com/three@0.145.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.145.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>

<script>
// ===================== Scene & Camera =====================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xa8dffb);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 20000);
camera.position.set(0, 50, 100);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.maxPolarAngle = Math.PI/2.2; // 上限
controls.minPolarAngle = Math.PI/6;   // 下限

scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dir = new THREE.DirectionalLight(0xffffff, 0.9);
dir.position.set(100,200,100);
scene.add(dir);

// ===================== Player =====================
const playerGeo = new THREE.CapsuleGeometry(3,6,4,8);
const playerMat = new THREE.MeshPhongMaterial({color:0xff5555});
const player = new THREE.Mesh(playerGeo, playerMat);
player.position.y = 10;
scene.add(player);

// ===================== Ground =====================
const groundGeo = new THREE.PlaneGeometry(1000,1000);
const groundMat = new THREE.MeshPhongMaterial({color:0x88cc88});
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ===================== Joystick =====================
let joystickDir = {x:0, y:0};
const joystick = nipplejs.create({zone: document.getElementById('joystickContainer'), mode:'static', position:{left:75, top:75}, color:'blue'});

joystick.on('move', (evt, data)=>{
  const rad = data.angle.radian;
  const force = Math.min(data.force/50, 1);
  joystickDir.x = Math.sin(rad) * force;
  joystickDir.y = Math.cos(rad) * force; // 上下は逆で修正済み
});
joystick.on('end', ()=>{ joystickDir.x = 0; joystickDir.y = 0; });

// ===================== Jump / Attack =====================
const jumpBtn = document.getElementById('jumpBtn');
const attackBtn = document.getElementById('attackBtn');

let velocityY = 0;
const gravity = -0.5;
const jumpSpeed = 8;
let onGround = true;

jumpBtn.addEventListener('touchstart', ()=>{
  if(onGround){
    velocityY = jumpSpeed;
    onGround = false;
  }
});

// とりあえず攻撃ボタンは空
attackBtn.addEventListener('touchstart', ()=>{console.log("Attack button pressed");});

// ===================== Movement =====================
const speed = 1.8;

function updatePlayer(){
  // XZ方向移動
  const dir = new THREE.Vector3(joystickDir.x,0,joystickDir.y);
  if(dir.length() > 0.05){
    dir.normalize();
    const camYaw = Math.atan2(camera.position.x - player.position.x, camera.position.z - player.position.z);
    const moveAngle = Math.atan2(dir.x, dir.z);
    const finalAngle = moveAngle + camYaw;

    // キャラクター回転
    const delta = finalAngle - player.rotation.y;
    player.rotation.y += delta * 0.2;

    // XZ移動
    player.position.x += Math.sin(finalAngle)*speed;
    player.position.z += Math.cos(finalAngle)*speed;
  }

  // Y軸ジャンプ・重力
  velocityY += gravity * 0.5;
  player.position.y += velocityY * 0.5;

  // 地面判定
  if(player.position.y <= 10){
    player.position.y = 10;
    velocityY = 0;
    onGround = true;
  } else {
    onGround = false;
  }

  // カメラ追従（XZ＋Y少し上）
  const camOffset = new THREE.Vector3(0,30,50);
  const rotatedOffset = camOffset.clone();
  rotatedOffset.applyAxisAngle(new THREE.Vector3(0,1,0), player.rotation.y);
  camera.position.lerp(player.position.clone().add(rotatedOffset),0.1);
  controls.target.lerp(player.position,0.1);
}

// ===================== Animate =====================
function animate(){
  requestAnimationFrame(animate);
  controls.update();
  updatePlayer();
  renderer.render(scene,camera);
}
animate();

// ===================== Resize =====================
window.addEventListener('resize', ()=>{
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});
</script>
</body>
</html>
