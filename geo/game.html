<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>3D街中キャラクター + ジョイスティック</title>
<style>
body{margin:0;overflow:hidden;font-family:Arial,Helvetica;}
#info{
  position:absolute;left:10px;top:10px;z-index:20;background:rgba(255,255,255,0.9);
  padding:8px;border-radius:6px;font-size:13px
}

/* ジョイスティックUI */
#joystick{
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(200,200,200,0.3);
  touch-action: none;
}
#stick{
  position: absolute;
  width: 60px;
  height: 60px;
  left: 30px; top: 30px;
  border-radius: 50%;
  background: rgba(100,100,100,0.6);
}
</style>
</head>
<body>
<div id="info">
ドラッグで視点調整 / PCはWASD / スマホは左下ジョイスティック
</div>

<div id="joystick"><div id="stick"></div></div>

<script src="https://unpkg.com/three@0.145.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.145.0/examples/js/controls/OrbitControls.js"></script>

<script>
/* ===================== Three.js 基本 ===================== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xa8dffb);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 20000);
camera.position.set(0, 10, 20);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.08;

scene.add(new THREE.AmbientLight(0xffffff,0.6));
const dir = new THREE.DirectionalLight(0xffffff,0.9);
dir.position.set(50,100,50);
scene.add(dir);

/* ===================== マップ ===================== */
const mapGroup = new THREE.Group();
scene.add(mapGroup);

const mapSize = 20;
for(let x=-mapSize/2;x<mapSize/2;x++){
  for(let z=-mapSize/2;z<mapSize/2;z++){
    const h = Math.random()*5+2;
    const geo = new THREE.BoxGeometry(1,h,1);
    const mat = new THREE.MeshStandardMaterial({color:0x999999});
    const b = new THREE.Mesh(geo, mat);
    b.position.set(x*2+1,h/2,z*2+1);
    mapGroup.add(b);
  }
}

const floorGeo = new THREE.PlaneGeometry(mapSize*2*2, mapSize*2*2);
const floorMat = new THREE.MeshStandardMaterial({color:0xcccccc});
const floor = new THREE.Mesh(floorGeo, floorMat);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ===================== プレイヤー ===================== */
const playerGeo = new THREE.BoxGeometry(1,2,1);
const playerMat = new THREE.MeshStandardMaterial({color:0xff0000});
const player = new THREE.Mesh(playerGeo, playerMat);
player.position.set(0,1,0);
scene.add(player);

/* カメラ追従 */
const cameraOffset = new THREE.Vector3(0,6,12);
function updateCamera(){
  const desired = player.position.clone().add(cameraOffset);
  camera.position.lerp(desired,0.1);
  camera.lookAt(player.position);
}

/* ===================== 移動 ===================== */
const keys={};
window.addEventListener('keydown', e=> keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup', e=> keys[e.key.toLowerCase()]=false);

let joystickDir = new THREE.Vector3();

/* ===================== ジョイスティックUI ===================== */
const joystick = document.getElementById('joystick');
const stick = document.getElementById('stick');
let activeTouch = null;

joystick.addEventListener('touchstart', e=>{
  activeTouch = e.changedTouches[0].identifier;
});
joystick.addEventListener('touchmove', e=>{
  if(activeTouch===null) return;
  for(const t of e.changedTouches){
    if(t.identifier!==activeTouch) continue;
    const rect = joystick.getBoundingClientRect();
    let dx = t.clientX - (rect.left + rect.width/2);
    let dy = t.clientY - (rect.top + rect.height/2);
    const maxDist = rect.width/2;
    const dist = Math.min(Math.sqrt(dx*dx+dy*dy), maxDist);
    const angle = Math.atan2(dy, dx);
    dx = Math.cos(angle)*dist;
    dy = Math.sin(angle)*dist;
    stick.style.transform = `translate(${dx}px, ${dy}px)`;
    joystickDir.set(dx/maxDist,0,-dy/maxDist);
  }
});
joystick.addEventListener('touchend', e=>{
  for(const t of e.changedTouches){
    if(t.identifier===activeTouch){
      activeTouch=null;
      stick.style.transform = `translate(0px,0px)`;
      joystickDir.set(0,0,0);
    }
  }
});

/* ===================== プレイヤー更新 ===================== */
function updatePlayer(delta){
  const speed = 5*delta;
  let dir = new THREE.Vector3();
  if(keys['w']) dir.z -=1;
  if(keys['s']) dir.z +=1;
  if(keys['a']) dir.x -=1;
  if(keys['d']) dir.x +=1;

  dir.add(joystickDir);
  if(dir.length()>0){
    dir.normalize();
    const angle = Math.atan2(camera.position.x - player.position.x, camera.position.z - player.position.z);
    dir.applyAxisAngle(new THREE.Vector3(0,1,0), angle);
    player.position.addScaledVector(dir,speed);
  }
}

/* ===================== アニメーション ===================== */
let prevTime = performance.now();
function animate(){
  requestAnimationFrame(animate);
  const now = performance.now();
  const delta = (now-prevTime)/1000;
  prevTime=now;

  updatePlayer(delta);
  updateCamera();
  controls.update();
  renderer.render(scene,camera);
}
animate();

/* ===================== リサイズ ===================== */
window.addEventListener('resize', ()=>{
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});
</script>
</body>
</html>
