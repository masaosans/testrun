#仕様（ChatGPT指示書）
以下の仕様に従って、Three.js + OSM（OpenStreetMap） 3D 表示 + LOD建物生成 + キャラクター移動 + 第三者視点カメラ + スマホ用ジョイスティック操作を統合した 1 枚の HTML を生成してください。

1. シーン全体の仕様
■ Three.js
r128（CDN）を使用すること
WebGLRenderer / Scene / PerspectiveCamera で初期化

■ OSM タイル表示
XYZ タイル（z/x/y.png）を読み込み
タイルごとにシーンに画像テクスチャを貼った平面を配置
カメラ位置に応じてタイルの更新（中心タイルのみ更新）

2. OSM 建物の 3D 表示（LOD）
■ OSM データ取得
Overpass API から OSM XML を取得
（buildings の way / node を読み取り）

■ 3D 建物生成
各 building polygon を ExtrudeGeometry で立体化
LOD（Level of Detail）を採用：
　近距離：フルポリゴン
　中距離：シンプル化
　遠距離：箱型

■ エラー対策
geometry.bounds が null の場合はスキップ
z-index（高さ）は OSM の height or levels を読み取りない場合はデフォルト高さで生成

3. キャラクター制御（Cylinder）
■ キャラ形状
Cylinder（高さ 1.7m）を作成
地面から少し浮かせた状態で配置

■ 移動仕様（キーボード）
WASD で移動（カメラ向きに合わせた移動）
Space でジャンプ
Shift でダッシュ

■ 重力処理
y 方向に重力をかけ、地面に接地するまで下降

4. カメラ制御（TPS：第三者視点）
■ カメラ挙動
キャラの後方 3m・上方 1m 付近に位置する TPS
カメラはキャラ位置を基準に追従
マウスドラッグで視点回転（OrbitControls ではなく自作）

■ カメラ移動の仕様
カメラの上下回転も可能（上下視点制御）
カメラはキャラに固定せず「追従」する
カメラの向きに合わせてキャラが前進する

5. スマホ用バーチャルジョイスティック
■ 2つのジョイスティックを配置
左：キャラクターの移動
右：カメラの向き（回転）

■ 動作仕様
右スティックの「上下」は視点の上下回転
　→ 上下は逆操作（上に倒す＝カメラは下を見る）
左スティックは前後左右移動

6. 地図座標系（緯度経度 ⇄ Three.js 座標）
■ 変換仕様
WebMercator の変換式を使用
mercToWorld / worldToMerc
worldToLatLon / latLonToWorld
カメラの位置の緯度経度を常に計算し、タイル更新

7. アニメーションループ
■ 毎フレーム実行
キャラクターの移動更新
カメラ追従処理
ジャンプ＋重力処理
タイル更新（カメラ位置から生成）
3D 建物の LOD 判定
ジョイスティック入力の反映

8. レスポンシブ対応
スマホでフルスクリーン表示
タッチ操作は全てジョイスティックへ集約
PC では WASD ＋ マウス操作

9. エラーなく動作する 1 枚の HTML として出力
<html>〜</html> まで完全な単一ファイル
JavaScript は <script> 内に全て記述
外部ライブラリは CDN で OK
地図タイルは OSM の一般的な URL を使用

10. 特記事項
建物生成で bounds === null の警告は無視して OK（仕様）
ソースは整理され、コメントが適度に付与されていること
機能単位で関数化され、読みやすい構成で作成されること


#以下のソースをもとに、修正版を作成してください。
##キャラクターは**もっと小さく**してください。今の1/4ぐらいのサイズが理想です。
###1/4は高さを指します。高さを1/4にするのに合わせて、全体を同じ比率で小さくしてください。
##現在はカメラがキャラクターを追従していますが、カメラを左右に自由に動かせるよう修正してください。移動中でも動かせる形にしてほしいです。また、キャラクターは**カメラの向いた方向**に移動するようにしてください。
##上下にもカメラを移動できるようにしてください。上下の移動幅は制限して問題ないです。移動中でもカメラを上下に移動できる状態にしてほしいです。
##移動しながらジャンプできるようにしてください。今は移動中はジャンプを押しても動きません。移動中のジャンプは移動方向のベクトルも反映させ、自然なジャンプにしてください。

＝＝
元ソースをベースに、以下の修正をお願いします。
 ・キャラクターがカメラの向きではなく、カメラから見て左の方向に動いています。ジョイスティックを上向きに動かすとカメラの向いている方向にキャラクターが進むようにしてください。下向きはカメラとは逆方向。ジョイスティックの左右はカメラの向きからみて左右に動くように。
・カメラのズーム変更は操作できなくてもいいです。
・カメラはキャラクターにもう少し寄せてください。また、カメラ自体の位置はキャラクターと一定距離で追従が必要です。その上で、左右を自由に動かせる状態を維持してください。
・キャラクターの動きが遅すぎます。ジャンプ時のスピードもそうです。


#修正元のソースは以下です。
