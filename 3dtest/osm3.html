<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>OSM 3D 広域サンプル</title>
<style>
body { margin:0; overflow:hidden; }
canvas { display:block; }
#ui {
  position: fixed; top: 8px; left: 8px; background: rgba(255,255,255,0.8);
  padding: 6px 8px; border-radius: 6px; font-family: sans-serif; font-size: 14px;
}
button { margin: 2px; }
</style>
</head>
<body>
<div id="ui">
  <button onclick="setCameraTPS()">TPS視点</button>
  <button onclick="setCameraOblique()">斜め俯瞰</button>
  <button onclick="setCameraTop()">上空俯瞰</button>
  <button onclick="setCameraRotate()">自由回転</button>
</div>

<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.159.0/examples/js/controls/OrbitControls.js"></script>

<script>
// ----------------------------
// ① Three.js 基本セットアップ
// ----------------------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 5000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

// 光
const dir = new THREE.DirectionalLight(0xffffff, 1);
dir.position.set(100, 200, 100);
scene.add(dir);
scene.add(new THREE.AmbientLight(0xffffff, 0.4));

// 地面
const groundGeo = new THREE.PlaneGeometry(5000,5000);
const groundMat = new THREE.MeshStandardMaterial({color:0x7cfc00});
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// OrbitControls（自由回転用）
let controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enabled = false;

// ----------------------------
// ② 簡易窓テクスチャ
const canvas = document.createElement('canvas');
canvas.width = canvas.height = 64;
const ctx = canvas.getContext('2d');
ctx.fillStyle = "#8888aa"; ctx.fillRect(0,0,64,64);
ctx.fillStyle = "#222222";
for(let y=2;y<64;y+=8){
  for(let x=2;x<64;x+=8){
    ctx.fillRect(x,y,4,4);
  }
}
const windowTex = new THREE.CanvasTexture(canvas);

// ----------------------------
// ③ 緯度経度 → Three.js X,Z 変換
function latLonToXZ(lat, lon, refLat, refLon){
    const R = 6378137;
    const dLat = (lat - refLat) * Math.PI / 180;
    const dLon = (lon - refLon) * Math.PI / 180;
    const x = dLon * R * Math.cos(refLat * Math.PI / 180);
    const z = -dLat * R;
    return [x, z];
}

// ----------------------------
// ④ OSM 建物データロード（広域）
const minLat = 35.675, maxLat = 35.695;
const minLon = 139.760, maxLon = 139.780;

const query = `
[out:json][timeout:25];
(
  way["building"](${minLat},${minLon},${maxLat},${maxLon});
);
out body;
>;
out skel qt;
`;

fetch('https://overpass-api.de/api/interpreter',{
  method:'POST',
  body: query
}).then(res=>res.json())
.then(data=>{
  const nodes = {};
  data.elements.forEach(e=>{ if(e.type==="node") nodes[e.id]=e; });

  data.elements.forEach(e=>{
    if(e.type==="way" && e.tags && e.tags.building){
      const coords = e.nodes.map(id=>{
        const n = nodes[id];
        return latLonToXZ(n.lat, n.lon, minLat, minLon);
      });

      let height = 20;
      if(e.tags.height){
        const h = parseFloat(e.tags.height.replace('m',''));
        if(!isNaN(h)) height = h;
      } else if(e.tags['building:levels']){
        const lv = parseFloat(e.tags['building:levels']);
        if(!isNaN(lv)) height = lv*3;
      }

      const shape = new THREE.Shape();
      coords.forEach((p,i)=>{ if(i===0) shape.moveTo(p[0],p[1]); else shape.lineTo(p[0],p[1]); });
      const geo = new THREE.ExtrudeGeometry(shape, {depth: height, bevelEnabled:false});
      const mat = new THREE.MeshStandardMaterial({map: windowTex});
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.y = 0;
      scene.add(mesh);
    }
  });
});

// ----------------------------
// ⑤ カメラ位置切替
function setCameraTPS(){
  controls.enabled = false;
  camera.position.set(500,50,500);
  camera.lookAt(0,0,0);
}
function setCameraOblique(){
  controls.enabled = false;
  camera.position.set(1000,400,1000);
  camera.lookAt(0,0,0);
}
function setCameraTop(){
  controls.enabled = false;
  camera.position.set(0,1000,0);
  camera.lookAt(0,0,0);
}
function setCameraRotate(){
  controls.enabled = true;
  controls.target.set(0,0,0);
  controls.update();
}

// 初期カメラ
setCameraOblique();

// ----------------------------
// ⑥ レンダリングループ
function animate(){
  requestAnimationFrame(animate);
  if(controls.enabled) controls.update();
  renderer.render(scene,camera);
}
animate();

// ----------------------------
// リサイズ対応
window.addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
