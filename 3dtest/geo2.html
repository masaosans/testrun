<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>渋谷建物 3D (POST 方式)</title>
<style>
  body { margin:0; overflow:hidden; }
  #ui { position:absolute; top:10px; left:10px; z-index:10;
       background:rgba(255,255,255,0.8); padding:8px; border-radius:6px;}
</style>
</head>
<body>

<div id="ui">
  <button id="loadBtn">建物ロード（渋谷）</button>
</div>

<!-- Three.js グローバル -->
<script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
// ==========================
// Three.js 初期化
// ==========================
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xa0c4ff);

const camera = new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,5000);
camera.position.set(0,300,400);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target.set(0,0,0);

// Light
scene.add(new THREE.AmbientLight(0xffffff,0.5));
const sun = new THREE.DirectionalLight(0xffffff,0.8);
sun.position.set(300,600,300);
scene.add(sun);

// Ground + OSMタイル風背景
const loader = new THREE.TextureLoader();
const mapTex = loader.load('https://tile.openstreetmap.org/16/58269/25805.png'); // 渋谷付近
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(500,500),
  new THREE.MeshPhongMaterial({ map: mapTex })
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ==========================
// 緯度経度 → 3D座標変換
// ==========================
function lon2x(lon){ return (lon-139.699)*100000; }
function lat2z(lat){ return -(lat-35.659)*100000; }

// ==========================
// GeoJSON → 3D建物
// ==========================
function addBuildingsFromGeoJSON(geojson){
  const texLoader = new THREE.TextureLoader();
  const windowTex = texLoader.load('https://i.imgur.com/4NJx7G9.png'); // 窓パターン

  geojson.features.forEach(f=>{
    if(!f.geometry || f.geometry.type!=="Polygon") return;
    const coords = f.geometry.coordinates[0];
    const shape = new THREE.Shape();
    coords.forEach((pt,i)=>{
      const x = lon2x(pt[0]);
      const z = lat2z(pt[1]);
      if(i===0) shape.moveTo(x,z);
      else shape.lineTo(x,z);
    });

    // 高さ
    let height=10;
    const p = f.properties||{};
    if(p.height) height=parseFloat(String(p.height).replace('m',''));
    else if(p["building:levels"]) height=parseFloat(p["building:levels"])*3;

    // 色分け
    let color=0x88aaff;
    if(height>60) color=0xffaa88;
    else if(height>40) color=0xaaff88;

    const geo = new THREE.ExtrudeGeometry(shape,{depth:height,bevelEnabled:false});
    const mat = new THREE.MeshPhongMaterial({map:windowTex, color:color});
    const mesh = new THREE.Mesh(geo, mat);
    mesh.rotation.x=-Math.PI/2;
    mesh.position.y=height/2;
    scene.add(mesh);
  });
}

// ==========================
// POST 方式で Overpass API 取得
// ==========================
async function fetchShibuyaBuildingsPOST(){
  const query = `
    [out:json][timeout:25];
    (
      way["building"](35.658,139.699,35.662,139.703);
    );
    (._;>;);
    out geom;
  `;
  try{
    const res = await fetch("https://overpass-api.de/api/interpreter", {
      method:"POST",
      body: query
    });
    const data = await res.json();
    addBuildingsFromGeoJSON(data);
    console.log("建物ロード完了");
  }catch(err){
    console.error("建物取得エラー:", err);
  }
}

// ==========================
// UIボタン
// ==========================
document.getElementById('loadBtn').onclick = ()=>{ fetchShibuyaBuildingsPOST(); };

// ==========================
// Render loop
// ==========================
function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
